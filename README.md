# terraform-aws-tardigrade-s3-bucket

Terraform module to create a S3 bucket

## Testing

Manual testing:

```
# Replace "xxx" with an actual AWS profile, then execute the integration tests.
export AWS_PROFILE=xxx 
make terraform/pytest PYTEST_ARGS="-v --nomock"
```

For automated testing, PYTEST_ARGS is optional and no profile is needed:

```
make mockstack/up
make terraform/pytest PYTEST_ARGS="-v"
make mockstack/clean
```

<!-- BEGIN TFDOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 0.12 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | n/a |

## Resources

| Name | Type |
|------|------|
| [aws_canonical_user_id.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/canonical_user_id) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_acl"></a> [acl](#input\_acl) | The canned ACL the bucket will use | `string` | `null` | no |
| <a name="input_bucket"></a> [bucket](#input\_bucket) | The name of the bucket | `string` | `null` | no |
| <a name="input_bucket_inventory"></a> [bucket\_inventory](#input\_bucket\_inventory) | Schema object of the S3 bucket inventory configuration | <pre>object({<br>    name                     = string # (Required) Unique identifier of the inventory configuration for the bucket.<br>    included_object_versions = string # (Required) Object versions to include in the inventory list. Valid values: All, Current.<br>    enabled                  = bool   # (Optional, Default: true) Specifies whether the inventory is enabled or disabled.<br><br>    schedule = object({  # (Required) Specifies the schedule for generating inventory results.<br>      frequency = string # (Required) Specifies how frequently inventory results are produced. Valid values: Daily, Weekly.<br>    })<br>    destination = object({  # (Required) Contains information about where to publish the inventory results.<br>      bucket = object({     # (Required) The S3 bucket configuration where inventory results are published.<br>        bucket_arn = string # (Required) The Amazon S3 bucket ARN of the destination.<br>        format     = string # (Required) Specifies the output format of the inventory results. Can be CSV, ORC or Parquet.<br>        account_id = string # (Optional) The ID of the account that owns the destination bucket. Recommended to be set to prevent problems if the destination bucket ownership changes.<br>        prefix     = string # (Optional) The prefix that is prepended to all inventory results.<br>        //encryption = object({         # (Optional) Contains the type of server-side encryption to use to encrypt the inventory<br><br>        //})<br>      })<br>    })<br>    filter = object({ # (Optional) Specifies an inventory filter. The inventory only includes objects that meet the filter's criteria<br>      prefix = string # (Optional) The prefix that an object must have to be included in the inventory results.<br>    })<br>    //optional_fields = list(string)   # (Optional) List of optional fields that are included in the inventory results. Poorly documented!<br>  })</pre> | `null` | no |
| <a name="input_cors_configuration"></a> [cors\_configuration](#input\_cors\_configuration) | List of cors rules the S3 bucket | <pre>object({<br>    expected_bucket_owner = string  # (Optional, Forces new resource) The account ID of the expected bucket owner.<br>    cors_rules = set(object({       # (Required) Set of origins and methods (cross-origin access that you want to allow). You can configure up to 100 rules.<br>      allowed_headers = set(string) # (Optional) Set of Headers that are specified in the Access-Control-Request-Headers header.<br>      allowed_methods = set(string) # (Required) Set of HTTP methods that you allow the origin to execute. Valid values are GET, PUT, HEAD, POST, and DELETE.<br>      allowed_origins = set(string) # (Required) Set of origins you want customers to be able to access the bucket from.<br>      expose_headers  = set(string) # (Optional) Set of headers in the response that you want customers to be able to access from their applications (for example, from a JavaScript XMLHttpRequest object).<br>      id              = string      # (Optional) Unique identifier for the rule. The value cannot be longer than 255 characters.<br>      max_age_seconds = number      # (Optional) The time in seconds that your browser is to cache the preflight response for the specified resource.<br>    }))<br>  })</pre> | `null` | no |
| <a name="input_create_policy"></a> [create\_policy](#input\_create\_policy) | Enable or disable creating bucket policies | `bool` | `false` | no |
| <a name="input_force_destroy"></a> [force\_destroy](#input\_force\_destroy) | Boolean that indicates all objects should be deleted from the bucket so that the bucket can be destroyed without error | `bool` | `false` | no |
| <a name="input_grants"></a> [grants](#input\_grants) | A list of ACL policy grants. Conflicts with `acl`, which must be set to `null` | <pre>list(object({<br>    id          = string<br>    type        = string<br>    permissions = string<br>    uri         = string<br>  }))</pre> | `[]` | no |
| <a name="input_intelligent_tiering_configuration"></a> [intelligent\_tiering\_configuration](#input\_intelligent\_tiering\_configuration) | Intelligent\_tiering\_configurations for the S3 bucket | <pre>object({<br>    name   = string        # (Required) The unique name used to identify the S3 Intelligent-Tiering configuration for the bucket.<br>    status = string        # (Required) The status of the rule. Either "Enabled" or "Disabled". The rule is ignored if status is not "Enabled".<br>    filter = object({      # (Optional) Filter that identifies subset of objects to which the replication rule applies<br>      prefix = string      # (Optional) An object key name prefix that identifies the subset of objects to which the configuration applies.<br>      tags   = map(string) # (Optional) All of these tags must exist in the object's tag set in order for the configuration to apply.<br>    })<br>    tiering = set(object({ # (Required) The S3 Intelligent-Tiering storage class tiers of the configuration<br>      access_tier = string # (Required) S3 Intelligent-Tiering access tier. Valid values: ARCHIVE_ACCESS, DEEP_ARCHIVE_ACCESS.<br>      days        = number # (Required) The number of consecutive days of no access after which an object will be eligible to be transitioned to the corresponding tier.<br>    }))<br>  })</pre> | `null` | no |
| <a name="input_lifecycle_rules"></a> [lifecycle\_rules](#input\_lifecycle\_rules) | n/a | <pre>list(object({<br>    id     = string # (Required) Unique identifier for the rule.<br>    status = string # (Required) Whether the rule is currently being applied. Valid values: Enabled or Disabled.<br><br>    abort_incomplete_multipart_upload = object({<br>      days_after_initiation = number # number of days after which Amazon S3 aborts an incomplete multipart upload.<br>    })<br><br>    filter = object({<br>      prefix                   = string      # (Optional) Prefix identifying one or more objects to which the rule applies.<br>      tags                     = map(string) # (Optional) Key-value map of resource tags. All of these tags must exist in the object's tag set in order for the rule to apply.<br>      object_size_greater_than = number      # (Optional) Minimum object size to which the rule applies. Value must be at least 0 if specified.<br>      object_size_less_than    = number      # (Optional) Maximum object size to which the rule applies. Value must be at least 1 if specified.<br>      and = list(object({                    # (Optional) Configuration block used to apply a logical AND to two or more predicates<br>        prefix                   = string<br>        tags                     = map(string)<br>        object_size_greater_than = number<br>        object_size_less_than    = number<br>      }))<br>    })<br><br>    expiration = object({<br>      date                         = string # (Optional) The date the object is to be moved or deleted. Should be in RFC3339 format.<br>      days                         = number # (Optional) The lifetime, in days, of the objects that are subject to the rule. The value must be a non-zero positive integer.<br>      expired_object_delete_marker = string # (Optional, Conflicts with date and days) Indicates whether Amazon S3 will remove a delete marker with no noncurrent versions. If set to true, the delete marker will be expired; if set to false the policy takes no action.<br>    })<br><br>    transitions = list(object({<br>      date          = string # Must be set to midnight UTC e.g. 2023-01-13T00:00:00Z.<br>      days          = number # Must be a positive integer<br>      storage_class = string # Valid Values: GLACIER, STANDARD_IA, ONEZONE_IA, INTELLIGENT_TIERING, DEEP_ARCHIVE, GLACIER_IR<br>    }))<br><br>    noncurrent_version_expiration = object({<br>      noncurrent_days           = number # days an object is noncurrent before Amazon S3 can perform the associated action. Must be a positive integer.<br>      newer_noncurrent_versions = number # number of noncurrent versions Amazon S3 will retain. Must be a non-zero positive integer.<br>    })<br><br>    noncurrent_version_transition = list(object({<br>      noncurrent_days           = number # days an object is noncurrent before Amazon S3 can perform the associated action. Must be a positive integer.<br>      newer_noncurrent_versions = number # number of noncurrent versions Amazon S3 will retain. Must be a non-zero positive integer.<br>      storage_class             = string # Valid Values: GLACIER, STANDARD_IA, ONEZONE_IA, INTELLIGENT_TIERING, DEEP_ARCHIVE, GLACIER_IR<br>    }))<br>  }))</pre> | `[]` | no |
| <a name="input_logging"></a> [logging](#input\_logging) | Schema object for the S3 bucket logging configuration | <pre>object({<br>    target_bucket         = string # (Required) The name of the bucket where you want Amazon S3 to store server access logs.<br>    target_prefix         = string # (Required) A prefix for all log object keys.<br>    expected_bucket_owner = string # (Optional, Forces new resource) The account ID of the expected bucket owner.<br>    target_grants = list(object({<br>      grantee = object({<br>        email_address = string # (Optional) Email address of the grantee. See Regions and Endpoints for supported AWS regions where this argument can be specified.<br>        id            = string # (Optional) The canonical user ID of the grantee.<br>        type          = string # (Required) Type of grantee. Valid values: CanonicalUser, AmazonCustomerByEmail, Group.<br>        uri           = string # (Optional) URI of the grantee group.<br>      })<br>      permission = string # (Required) Logging permissions assigned to the grantee for the bucket. Valid values: FULL_CONTROL, READ, WRITE.<br>    }))<br>  })</pre> | `null` | no |
| <a name="input_notifications"></a> [notifications](#input\_notifications) | A schema object for the S3 bucket notifications configuration | <pre>object({<br>    lambda_functions = list(object({<br>      lambda_function_arn = string<br>      events              = list(string)<br>      filter_prefix       = string<br>      filter_suffix       = string<br>    }))<br>    topics = list(object({<br>      topic_arn     = string<br>      events        = list(string)<br>      filter_prefix = string<br>      filter_suffix = string<br>    }))<br>    queues = list(object({<br>      queue_arn     = string<br>      events        = list(string)<br>      filter_prefix = string<br>      filter_suffix = string<br>    }))<br>  })</pre> | <pre>{<br>  "lambda_functions": [],<br>  "queues": [],<br>  "topics": []<br>}</pre> | no |
| <a name="input_ownership_controls"></a> [ownership\_controls](#input\_ownership\_controls) | List of schema objects for the S3 ownership controls | <pre>object({<br>    rule = object({             # (Required) Configuration block with Ownership Controls rules.<br>      object_ownership = string # (Required) Object ownership. Valid values: BucketOwnerPreferred, ObjectWriter or BucketOwnerEnforced<br>    })<br>  })</pre> | `null` | no |
| <a name="input_policy"></a> [policy](#input\_policy) | An IAM policy document in JSON format to apply to the bucket | `string` | `null` | no |
| <a name="input_public_access_block"></a> [public\_access\_block](#input\_public\_access\_block) | A schema object for the S3 bucket public access block policy | <pre>object({<br>    block_public_acls       = bool<br>    block_public_policy     = bool<br>    ignore_public_acls      = bool<br>    restrict_public_buckets = bool<br>  })</pre> | <pre>{<br>  "block_public_acls": true,<br>  "block_public_policy": true,<br>  "ignore_public_acls": true,<br>  "restrict_public_buckets": true<br>}</pre> | no |
| <a name="input_replication_configuration"></a> [replication\_configuration](#input\_replication\_configuration) | Schema object of the S3 replication configuration | <pre>object({<br>    role = string                               # Required) The ARN of the IAM role for Amazon S3 to assume when replicating the objects.<br>    rules = list(object({                       # (Required) List of configuration blocks describing the rules managing the replication<br>      delete_marker_replication_status = string # (Optional) Whether delete markers are replicated. This argument is only valid with V2 replication configurations (i.e., when filter is used)<br>      id                               = string # (Optional) Unique identifier for the rule. Must be less than or equal to 255 characters in length.<br>      priority                         = number # (Optional) The priority associated with the rule. Priority should only be set if filter is configured. If not provided, defaults to 0. Priority must be unique between multiple rules.<br>      status                           = string # (Required) The status of the rule. Either "Enabled" or "Disabled". The rule is ignored if status is not "Enabled".<br>      destination = object({                    # Required) Specifies the destination for the rule<br>        bucket        = string                  # (Required) The ARN of the S3 bucket where you want Amazon S3 to store replicas of the objects identified by the rule.<br>        storage_class = string                  # (Optional) The storage class used to store the object. By default, Amazon S3 uses the storage class of the source object to create the object replica.<br>        account       = string                  # (Optional) The Account ID to specify the replica ownership. Must be used in conjunction with access_control_translation override configuration.<br>        encryption_configuration = object({     # (Optional) A configuration block that provides information about encryption. If source_selection_criteria is specified, you must specify this element<br>          replica_kms_key_id = string           # (Required) The ID (Key ARN or Alias ARN) of the customer managed AWS KMS key stored in AWS Key Management Service (KMS) for the destination bucket.<br>        })<br>        access_control_translation = object({ # (Optional) A configuration block that specifies the overrides to use for object owners on replication<br>          owner = string                      # (Required) Specifies the replica ownership. Valid values: Destination.<br>        })<br>        metrics = object({           # (Optional) A configuration block that specifies replication metrics-related settings enabling replication metrics and events<br>          status = string            # (Required) The status of the Destination Metrics. Either "Enabled" or "Disabled".<br>          event_threshold = object({ # (Optional) A configuration block that specifies the time threshold for emitting the s3:Replication:OperationMissedThreshold event<br>            minutes = number         # (Required) Time in minutes. Valid values: 15.<br>          })<br>        })<br>        replication_time = object({ # Optional) A configuration block that specifies S3 Replication Time Control (S3 RTC), including whether S3 RTC is enabled and the time when all objects and operations on objects must be replicated. Replication Time Control must be used in conjunction with metrics.<br>          status = string           # (Required) The status of the Destination Metrics. Either "Enabled" or "Disabled".<br>          time = object({           # (Required) A configuration block specifying the time by which replication should be complete for all objects and operations on objects<br>            minutes = number        # (Required) Time in minutes. Valid values: 15.<br>          })<br>        })<br>      })<br>      filter = object({        # (Optional) Filter that identifies subset of objects to which the replication rule applies<br>        prefix = string        # (Optional) An object key name prefix that identifies subset of objects to which the rule applies.<br>        tags   = map(string)   # (Optional) A configuration block for specifying a tag key and value<br>        and = list(object({    # (Optional) A configuration block for specifying rule filters. This element is required only if you specify more than one filter.<br>          prefix = string      # (Optional) An object key name prefix that identifies subset of objects to which the rule applies.<br>          tags   = map(string) # (Optional) A map of tags (key and value pairs) that identifies a subset of objects to which the rule applies. The rule applies only to objects having all the tags in its tagset.<br>        }))<br>      })<br>      source_selection_criteria = object({ # (Optional) Specifies special object selection criteria<br>        replica_modifications = object({   # (Optional) A configuration block that you can specify for selections for modifications on replicas. Amazon S3 doesn't replicate replica modifications by default. In the latest version of replication configuration (when filter is specified), you can specify this element and set the status to Enabled to replicate modifications on replicas.<br>          status = string                  # (Required) Whether the existing objects should be replicated. Either "Enabled" or "Disabled".<br>        })<br>        sse_kms_encrypted_objects = object({ # (Optional) A configuration block for filter information for the selection of Amazon S3 objects encrypted with AWS KMS. If specified, replica_kms_key_id in destination encryption_configuration must be specified as well. status = string # (Required) Whether the existing objects should be replicated. Either "Enabled" or "Disabled".<br>        })<br>      })<br>    }))<br>  })</pre> | `null` | no |
| <a name="input_request_payment_configuration"></a> [request\_payment\_configuration](#input\_request\_payment\_configuration) | Request payment configuration for the S3 bucket | <pre>object({<br>    expected_bucket_owner = string # (Optional, Forces new resource) The account ID of the expected bucket owner.<br>    payer                 = string # (Required) Specifies who pays for the download and request fees. Valid values: BucketOwner, Requester.<br>  })</pre> | `null` | no |
| <a name="input_server_side_encryption"></a> [server\_side\_encryption](#input\_server\_side\_encryption) | Enable or disable bucket server-side encrpyption | `bool` | `false` | no |
| <a name="input_server_side_encryption_configuration"></a> [server\_side\_encryption\_configuration](#input\_server\_side\_encryption\_configuration) | The values to be applied to the bucket server side encryption configuration | `list(any)` | <pre>[<br>  {<br>    "kms_master_key_id": null,<br>    "sse_algorithm": "aws:kms"<br>  }<br>]</pre> | no |
| <a name="input_tags"></a> [tags](#input\_tags) | The tags applied to the bucket | `map(string)` | `{}` | no |
| <a name="input_versioning"></a> [versioning](#input\_versioning) | The state of versioning of the bucket | `string` | `"Enabled"` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_bucket"></a> [bucket](#output\_bucket) | AWS S3 Bucket object |
| <a name="output_notification"></a> [notification](#output\_notification) | Object containing the AWS S3 Bucket notification configuration |
| <a name="output_public_access_block"></a> [public\_access\_block](#output\_public\_access\_block) | Object containing the AWS S3 Bucket public access block configuration |

<!-- END TFDOCS -->
